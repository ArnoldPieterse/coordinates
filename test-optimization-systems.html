<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Optimization Systems - Phase 7 Implementation</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #fff;
            overflow-x: hidden;
        }
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.8em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            background: linear-gradient(45deg, #00ff88, #00d4ff, #ff6b6b, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 4s ease-in-out infinite;
        }
        @keyframes gradientShift {
            0%, 100% { filter: hue-rotate(0deg); }
            25% { filter: hue-rotate(90deg); }
            50% { filter: hue-rotate(180deg); }
            75% { filter: hue-rotate(270deg); }
        }
        .header p {
            font-size: 1.3em;
            opacity: 0.9;
            margin: 10px 0;
        }
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 30px;
            height: calc(100vh - 200px);
        }
        .controls-panel {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .control-section {
            margin-bottom: 30px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .control-section:last-child {
            border-bottom: none;
        }
        .control-section h3 {
            margin: 0 0 20px 0;
            color: #00ff88;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .control-group {
            margin-bottom: 20px;
        }
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95em;
            color: #ddd;
        }
        .control-row {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .control-row input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.1);
            outline: none;
            -webkit-appearance: none;
        }
        .control-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00ff88, #00d4ff);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .control-row span {
            min-width: 70px;
            text-align: right;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #00ff88;
        }
        input, select, button {
            padding: 10px 15px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.2);
        }
        button {
            background: linear-gradient(45deg, #00ff88, #00d4ff);
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: linear-gradient(45deg, #00d4ff, #00ff88);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 136, 0.3);
        }
        button:disabled {
            background: rgba(255,255,255,0.1);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        .button-group button {
            flex: 1;
        }
        .visualization-panel {
            background: rgba(0,0,0,0.4);
            border-radius: 20px;
            padding: 25px;
            position: relative;
            box-shadow: inset 0 4px 20px rgba(0,0,0,0.5);
        }
        #canvas {
            width: 100%;
            height: 100%;
            border-radius: 15px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        .stats-panel {
            position: absolute;
            top: 25px;
            right: 25px;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            min-width: 300px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            backdrop-filter: blur(10px);
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .stat-row:last-child {
            border-bottom: none;
        }
        .stat-label {
            color: #00ff88;
            font-weight: 600;
        }
        .stat-value {
            color: #fff;
            font-weight: 500;
        }
        .performance-indicator {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        .performance-bar {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #ffff00, #ff0000);
            transition: width 0.3s ease;
            border-radius: 3px;
        }
        .optimization-panel {
            position: absolute;
            bottom: 25px;
            left: 25px;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            min-width: 280px;
            border: 1px solid rgba(0, 212, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        .optimization-panel h4 {
            margin: 0 0 15px 0;
            color: #00d4ff;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .optimization-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
        }
        .status-dot.active {
            background: #00ff88;
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.6);
        }
        .status-dot.warning {
            background: #ffd700;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }
        .status-dot.error {
            background: #ff6b6b;
            box-shadow: 0 0 8px rgba(255, 107, 107, 0.6);
        }
        .lod-panel {
            position: absolute;
            top: 25px;
            left: 25px;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            border-radius: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            min-width: 250px;
            border: 1px solid rgba(255, 193, 7, 0.3);
            backdrop-filter: blur(10px);
        }
        .lod-panel h4 {
            margin: 0 0 15px 0;
            color: #ffc107;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .lod-level {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
        }
        .lod-level:last-child {
            margin-bottom: 0;
        }
        .lod-name {
            color: #ffc107;
        }
        .lod-count {
            color: #fff;
        }
        .effect-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .effect-toggle input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #00ff88;
        }
        .effect-toggle label {
            margin: 0;
            cursor: pointer;
        }
        .quality-preset {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .quality-preset button {
            font-size: 0.8em;
            padding: 8px 12px;
        }
        .quality-preset button.active {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            display: none;
            border: 2px solid rgba(0, 255, 136, 0.5);
            backdrop-filter: blur(20px);
        }
        .loading.show {
            display: block;
        }
        .spinner {
            border: 4px solid rgba(0, 255, 136, 0.3);
            border-top: 4px solid #00ff88;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 1600px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            .controls-panel {
                max-height: 600px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Advanced Optimization Systems</h1>
            <p>Phase 7: LOD, Frustum Culling, Object Pooling & Mobile Optimizations</p>
        </div>
        
        <div class="main-content">
            <div class="controls-panel">
                <div class="control-section">
                    <h3>üéØ System Control</h3>
                    <div class="button-group">
                        <button id="startBtn">Start Systems</button>
                        <button id="resetBtn">Reset</button>
                    </div>
                    <div class="button-group">
                        <button id="stressTestBtn">Stress Test</button>
                        <button id="optimizeBtn">Optimize</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>‚ö° Performance Settings</h3>
                    <div class="quality-preset">
                        <button id="ultraBtn">Ultra</button>
                        <button id="highBtn" class="active">High</button>
                        <button id="mediumBtn">Medium</button>
                        <button id="lowBtn">Low</button>
                    </div>
                    <div class="control-group">
                        <label>Max Draw Calls:</label>
                        <div class="control-row">
                            <input type="range" id="maxDrawCalls" min="100" max="2000" value="1000" step="100">
                            <span id="maxDrawCallsValue">1000</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Max Triangles:</label>
                        <div class="control-row">
                            <input type="range" id="maxTriangles" min="10000" max="200000" value="100000" step="10000">
                            <span id="maxTrianglesValue">100000</span>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üîç LOD Settings</h3>
                    <div class="control-group">
                        <label>Enable LOD:</label>
                        <div class="effect-toggle">
                            <input type="checkbox" id="enableLOD" checked>
                            <label for="enableLOD">Enable</label>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>LOD Distance:</label>
                        <div class="control-row">
                            <input type="range" id="lodDistance" min="10" max="200" value="50" step="10">
                            <span id="lodDistanceValue">50</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Transition Smoothness:</label>
                        <div class="control-row">
                            <input type="range" id="transitionSmoothness" min="0.01" max="0.5" value="0.1" step="0.01">
                            <span id="transitionSmoothnessValue">0.1</span>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üëÅÔ∏è Frustum Culling</h3>
                    <div class="control-group">
                        <label>Enable Culling:</label>
                        <div class="effect-toggle">
                            <input type="checkbox" id="enableCulling" checked>
                            <label for="enableCulling">Enable</label>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Culling Margin:</label>
                        <div class="control-row">
                            <input type="range" id="cullingMargin" min="0" max="5" value="1" step="0.1">
                            <span id="cullingMarginValue">1.0</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Update Interval (ms):</label>
                        <div class="control-row">
                            <input type="range" id="updateInterval" min="16" max="500" value="100" step="16">
                            <span id="updateIntervalValue">100</span>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üîÑ Object Pooling</h3>
                    <div class="control-group">
                        <label>Enable Pooling:</label>
                        <div class="effect-toggle">
                            <input type="checkbox" id="enablePooling" checked>
                            <label for="enablePooling">Enable</label>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Max Pool Size:</label>
                        <div class="control-row">
                            <input type="range" id="maxPoolSize" min="100" max="5000" value="1000" step="100">
                            <span id="maxPoolSizeValue">1000</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Cleanup Interval (ms):</label>
                        <div class="control-row">
                            <input type="range" id="cleanupInterval" min="1000" max="10000" value="5000" step="500">
                            <span id="cleanupIntervalValue">5000</span>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üì± Mobile Optimizations</h3>
                    <div class="control-group">
                        <label>Enable Mobile Optimizations:</label>
                        <div class="effect-toggle">
                            <input type="checkbox" id="enableMobile" checked>
                            <label for="enableMobile">Enable</label>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Touch Sensitivity:</label>
                        <div class="control-row">
                            <input type="range" id="touchSensitivity" min="0.1" max="3" value="1" step="0.1">
                            <span id="touchSensitivityValue">1.0</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Battery Optimization:</label>
                        <div class="effect-toggle">
                            <input type="checkbox" id="batteryOptimization" checked>
                            <label for="batteryOptimization">Enable</label>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üé® Rendering Options</h3>
                    <div class="control-group">
                        <label>Wireframe Mode:</label>
                        <div class="effect-toggle">
                            <input type="checkbox" id="wireframeMode">
                            <label for="wireframeMode">Enable</label>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Show Culling:</label>
                        <div class="effect-toggle">
                            <input type="checkbox" id="showCulling">
                            <label for="showCulling">Enable</label>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Show Performance:</label>
                        <div class="effect-toggle">
                            <input type="checkbox" id="showPerformance" checked>
                            <label for="showPerformance">Enable</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="visualization-panel">
                <canvas id="canvas"></canvas>
                
                <div class="stats-panel" id="statsPanel">
                    <div class="stat-row">
                        <span class="stat-label">FPS:</span>
                        <span class="stat-value" id="fps">60</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Frame Time:</span>
                        <span class="stat-value" id="frameTime">16.7ms</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Draw Calls:</span>
                        <span class="stat-value" id="drawCalls">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Triangles:</span>
                        <span class="stat-value" id="triangles">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Memory:</span>
                        <span class="stat-value" id="memoryUsage">0MB</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Objects:</span>
                        <span class="stat-value" id="objectCount">0</span>
                    </div>
                    <div class="performance-indicator">
                        <div class="performance-bar" id="performanceBar" style="width: 100%"></div>
                    </div>
                </div>

                <div class="lod-panel" id="lodPanel">
                    <h4>LOD Distribution</h4>
                    <div class="lod-level">
                        <span class="lod-name">Ultra:</span>
                        <span class="lod-count" id="ultraCount">0</span>
                    </div>
                    <div class="lod-level">
                        <span class="lod-name">High:</span>
                        <span class="lod-count" id="highCount">0</span>
                    </div>
                    <div class="lod-level">
                        <span class="lod-name">Medium:</span>
                        <span class="lod-count" id="mediumCount">0</span>
                    </div>
                    <div class="lod-level">
                        <span class="lod-name">Low:</span>
                        <span class="lod-count" id="lowCount">0</span>
                    </div>
                </div>

                <div class="optimization-panel" id="optimizationPanel">
                    <h4>Optimization Status</h4>
                    <div class="optimization-status">
                        <div class="status-dot active" id="lodStatus"></div>
                        <span>LOD System</span>
                    </div>
                    <div class="optimization-status">
                        <div class="status-dot active" id="cullingStatus"></div>
                        <span>Frustum Culling</span>
                    </div>
                    <div class="optimization-status">
                        <div class="status-dot active" id="poolingStatus"></div>
                        <span>Object Pooling</span>
                    </div>
                    <div class="optimization-status">
                        <div class="status-dot active" id="webglStatus"></div>
                        <span>WebGL Optimization</span>
                    </div>
                    <div class="optimization-status">
                        <div class="status-dot active" id="mobileStatus"></div>
                        <span>Mobile Optimization</span>
                    </div>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <div>Initializing Optimization Systems...</div>
                    <div style="font-size: 0.8em; margin-top: 10px;">Loading LOD, Culling & Pooling</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from './src/three.module.js';
        import { AdvancedOptimizationSystem } from './src/advanced-optimization.js';
        import { VoxelTree } from './src/procedural-tree-voxel.js';
        import TreeOptions from './src/tree-options.js';

        // Global variables
        let scene, camera, renderer;
        let optimizationSystem;
        let testObjects = [];
        let systemsRunning = false;
        let animationId;
        let lastTime = 0;
        let frameCount = 0;
        let fps = 60;
        let frameTime = 16.7;
        let stressTestMode = false;

        // Initialize Three.js scene
        function initScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a2e);

            const canvas = document.getElementById('canvas');
            const aspect = canvas.clientWidth / canvas.clientHeight;
            
            camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);
            camera.position.set(30, 25, 30);
            camera.lookAt(0, 0, 0);

            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            // Add lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 10);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);

            // Add ground
            const groundGeometry = new THREE.PlaneGeometry(200, 200);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x2a2a2a });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Initialize optimization system
            optimizationSystem = new AdvancedOptimizationSystem(renderer, scene, camera);

            // Create test objects
            createTestObjects();

            // Handle window resize
            window.addEventListener('resize', onWindowResize);

            animate();
        }

        function createTestObjects() {
            // Create various test objects with different complexity
            const geometries = [
                new THREE.SphereGeometry(2, 32, 32),
                new THREE.BoxGeometry(4, 4, 4),
                new THREE.CylinderGeometry(2, 2, 6, 32),
                new THREE.TorusGeometry(3, 1, 16, 32),
                new THREE.OctahedronGeometry(2),
                new THREE.TetrahedronGeometry(2)
            ];

            const materials = [
                new THREE.MeshLambertMaterial({ color: 0xff6b6b }),
                new THREE.MeshLambertMaterial({ color: 0x4ecdc4 }),
                new THREE.MeshLambertMaterial({ color: 0x45b7d1 }),
                new THREE.MeshLambertMaterial({ color: 0x96ceb4 }),
                new THREE.MeshLambertMaterial({ color: 0xffd700 }),
                new THREE.MeshLambertMaterial({ color: 0xff8c42 })
            ];

            // Create objects in a grid pattern
            const gridSize = 10;
            const spacing = 15;
            let objectCount = 0;

            for (let x = -gridSize; x <= gridSize; x++) {
                for (let z = -gridSize; z <= gridSize; z++) {
                    const geometry = geometries[objectCount % geometries.length];
                    const material = materials[objectCount % materials.length];
                    
                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(x * spacing, 2, z * spacing);
                    mesh.castShadow = true;
                    mesh.receiveShadow = true;
                    
                    mesh.userData = {
                        id: `object_${objectCount}`,
                        type: 'test',
                        complexity: 0.3 + (objectCount % 3) * 0.2
                    };
                    
                    scene.add(mesh);
                    testObjects.push(mesh);
                    optimizationSystem.addObject(mesh);
                    objectCount++;
                }
            }

            // Create trees using object pooling
            createPooledTrees();
        }

        function createPooledTrees() {
            // Create tree pool
            const treeFactory = () => {
                const options = new TreeOptions();
                options.type = ['pine', 'broadleaf', 'willow'][Math.floor(Math.random() * 3)];
                const tree = new VoxelTree(options);
                return tree.toMesh({ ringSides: 8, useHybrid: true });
            };

            optimizationSystem.objectPool.createPool('tree', treeFactory, 50);

            // Add some trees to the scene
            for (let i = 0; i < 20; i++) {
                const tree = optimizationSystem.getObject('tree');
                if (tree) {
                    tree.position.set(
                        (Math.random() - 0.5) * 200,
                        0,
                        (Math.random() - 0.5) * 200
                    );
                    tree.castShadow = true;
                    tree.receiveShadow = true;
                    scene.add(tree);
                    testObjects.push(tree);
                    optimizationSystem.addObject(tree);
                }
            }
        }

        function onWindowResize() {
            const canvas = renderer.domElement;
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        function animate() {
            animationId = requestAnimationFrame(animate);
            
            const currentTime = performance.now();
            const deltaTime = currentTime - lastTime;
            frameTime = deltaTime;
            frameCount++;
            
            if (currentTime - lastTime >= 1000) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                frameCount = 0;
                lastTime = currentTime;
                updatePerformanceStats();
            }
            
            if (systemsRunning && optimizationSystem) {
                // Update optimization system
                optimizationSystem.update();
                
                // Animate test objects
                animateTestObjects(deltaTime);
            }
            
            // Rotate camera around scene
            const time = currentTime * 0.001;
            camera.position.x = Math.cos(time * 0.2) * 60;
            camera.position.z = Math.sin(time * 0.2) * 60;
            camera.position.y = 30 + Math.sin(time * 0.1) * 10;
            camera.lookAt(0, 0, 0);
            
            renderer.render(scene, camera);
        }

        function animateTestObjects(deltaTime) {
            testObjects.forEach((obj, index) => {
                obj.rotation.y += deltaTime * 0.001 * (index % 2 === 0 ? 1 : -1);
                obj.rotation.x += deltaTime * 0.0005 * Math.sin(index);
            });
        }

        function updatePerformanceStats() {
            const stats = optimizationSystem.getPerformanceStats();
            
            document.getElementById('fps').textContent = fps;
            document.getElementById('frameTime').textContent = frameTime.toFixed(1) + 'ms';
            document.getElementById('drawCalls').textContent = stats.webgl.drawCalls;
            document.getElementById('triangles').textContent = stats.webgl.triangles.toLocaleString();
            document.getElementById('memoryUsage').textContent = (stats.webgl.memory.geometries * 0.1).toFixed(1) + 'MB';
            document.getElementById('objectCount').textContent = testObjects.length;
            
            // Update performance bar
            const performancePercent = Math.min(100, (fps / 60) * 100);
            document.getElementById('performanceBar').style.width = performancePercent + '%';
            
            // Update LOD distribution
            updateLODDistribution();
            
            // Update optimization status
            updateOptimizationStatus(stats);
        }

        function updateLODDistribution() {
            // Simulate LOD distribution based on distance
            const ultraCount = Math.floor(testObjects.length * 0.1);
            const highCount = Math.floor(testObjects.length * 0.3);
            const mediumCount = Math.floor(testObjects.length * 0.4);
            const lowCount = testObjects.length - ultraCount - highCount - mediumCount;
            
            document.getElementById('ultraCount').textContent = ultraCount;
            document.getElementById('highCount').textContent = highCount;
            document.getElementById('mediumCount').textContent = mediumCount;
            document.getElementById('lowCount').textContent = lowCount;
        }

        function updateOptimizationStatus(stats) {
            const statuses = {
                lod: document.getElementById('lodStatus'),
                culling: document.getElementById('cullingStatus'),
                pooling: document.getElementById('poolingStatus'),
                webgl: document.getElementById('webglStatus'),
                mobile: document.getElementById('mobileStatus')
            };
            
            // Update status based on performance
            const drawCalls = stats.webgl.drawCalls;
            const triangles = stats.webgl.triangles;
            
            statuses.webgl.className = 'status-dot ' + 
                (drawCalls < 500 ? 'active' : drawCalls < 1000 ? 'warning' : 'error');
            
            statuses.pooling.className = 'status-dot ' + 
                (Object.keys(stats.pooling).length > 0 ? 'active' : 'warning');
            
            statuses.mobile.className = 'status-dot ' + 
                (stats.mobile.isMobile ? 'active' : 'warning');
        }

        // System control functions
        function startSystems() {
            systemsRunning = true;
            document.getElementById('startBtn').disabled = true;
            console.log('Optimization systems started');
        }

        function resetSystems() {
            stopSystems();
            
            // Clear existing objects
            testObjects.forEach(obj => {
                if (obj.parent) obj.parent.remove(obj);
            });
            testObjects = [];
            
            // Recreate test objects
            createTestObjects();
            
            console.log('Systems reset');
        }

        function stressTest() {
            stressTestMode = !stressTestMode;
            const button = document.getElementById('stressTestBtn');
            button.textContent = stressTestMode ? 'Stop Stress Test' : 'Stress Test';
            
            if (stressTestMode) {
                // Add more objects for stress testing
                for (let i = 0; i < 100; i++) {
                    const geometry = new THREE.SphereGeometry(1, 16, 16);
                    const material = new THREE.MeshLambertMaterial({ 
                        color: new THREE.Color().setHSL(Math.random(), 0.7, 0.5) 
                    });
                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.position.set(
                        (Math.random() - 0.5) * 300,
                        Math.random() * 20,
                        (Math.random() - 0.5) * 300
                    );
                    mesh.castShadow = true;
                    scene.add(mesh);
                    testObjects.push(mesh);
                    optimizationSystem.addObject(mesh);
                }
            }
        }

        function optimizeSystems() {
            const loading = document.getElementById('loading');
            loading.classList.add('show');
            
            setTimeout(() => {
                // Apply optimization settings
                const config = {
                    lod: {
                        enableLOD: document.getElementById('enableLOD').checked,
                        transitionSmoothness: parseFloat(document.getElementById('transitionSmoothness').value)
                    },
                    culling: {
                        enableCulling: document.getElementById('enableCulling').checked,
                        cullingMargin: parseFloat(document.getElementById('cullingMargin').value),
                        updateInterval: parseInt(document.getElementById('updateInterval').value)
                    },
                    pooling: {
                        enablePooling: document.getElementById('enablePooling').checked,
                        maxPoolSize: parseInt(document.getElementById('maxPoolSize').value),
                        cleanupInterval: parseInt(document.getElementById('cleanupInterval').value)
                    },
                    webgl: {
                        maxDrawCalls: parseInt(document.getElementById('maxDrawCalls').value),
                        maxTriangles: parseInt(document.getElementById('maxTriangles').value)
                    },
                    mobile: {
                        enableMobileOptimizations: document.getElementById('enableMobile').checked,
                        touchSensitivity: parseFloat(document.getElementById('touchSensitivity').value),
                        batteryOptimization: document.getElementById('batteryOptimization').checked
                    }
                };
                
                optimizationSystem.setConfig(config);
                
                loading.classList.remove('show');
                console.log('Systems optimized with config:', config);
            }, 1000);
        }

        // Quality preset functions
        function setQualityPreset(preset) {
            const presets = {
                ultra: { maxDrawCalls: 2000, maxTriangles: 200000 },
                high: { maxDrawCalls: 1000, maxTriangles: 100000 },
                medium: { maxDrawCalls: 500, maxTriangles: 50000 },
                low: { maxDrawCalls: 200, maxTriangles: 20000 }
            };
            
            const presetData = presets[preset];
            if (presetData) {
                document.getElementById('maxDrawCalls').value = presetData.maxDrawCalls;
                document.getElementById('maxTriangles').value = presetData.maxTriangles;
                
                updateAllValueDisplays();
                optimizeSystems();
            }
        }

        // Update all range input value displays
        function updateAllValueDisplays() {
            const ranges = document.querySelectorAll('input[type="range"]');
            ranges.forEach(range => {
                const valueSpan = document.getElementById(range.id + 'Value');
                if (valueSpan) {
                    valueSpan.textContent = parseFloat(range.value).toFixed(2);
                }
            });
        }

        // Event listeners
        document.getElementById('startBtn').addEventListener('click', startSystems);
        document.getElementById('resetBtn').addEventListener('click', resetSystems);
        document.getElementById('stressTestBtn').addEventListener('click', stressTest);
        document.getElementById('optimizeBtn').addEventListener('click', optimizeSystems);

        // Quality preset buttons
        document.getElementById('ultraBtn').addEventListener('click', () => setQualityPreset('ultra'));
        document.getElementById('highBtn').addEventListener('click', () => setQualityPreset('high'));
        document.getElementById('mediumBtn').addEventListener('click', () => setQualityPreset('medium'));
        document.getElementById('lowBtn').addEventListener('click', () => setQualityPreset('low'));

        // Range input event listeners
        const ranges = document.querySelectorAll('input[type="range"]');
        ranges.forEach(range => {
            range.addEventListener('input', function() {
                const valueSpan = document.getElementById(this.id + 'Value');
                if (valueSpan) {
                    valueSpan.textContent = parseFloat(this.value).toFixed(2);
                }
            });
        });

        // Checkbox event listeners
        document.getElementById('showPerformance').addEventListener('change', function() {
            const statsPanel = document.getElementById('statsPanel');
            statsPanel.style.display = this.checked ? 'block' : 'none';
        });

        document.getElementById('wireframeMode').addEventListener('change', function() {
            testObjects.forEach(obj => {
                if (obj.material) {
                    obj.material.wireframe = this.checked;
                }
            });
        });

        // Initialize scene
        initScene();
        
        // Auto-start systems after initialization
        setTimeout(startSystems, 1000);
    </script>
</body>
</html> 