<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Tree Generator - Hybrid L-System + Space Colonization</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            overflow-x: hidden;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            margin: 10px 0;
        }
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            height: calc(100vh - 200px);
        }
        .controls-panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.2);
            overflow-y: auto;
        }
        .control-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .control-section:last-child {
            border-bottom: none;
        }
        .control-section h3 {
            margin: 0 0 15px 0;
            color: #4CAF50;
            font-size: 1.1em;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9em;
        }
        .control-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .control-row input[type="range"] {
            flex: 1;
        }
        .control-row span {
            min-width: 50px;
            text-align: right;
            font-family: monospace;
            font-size: 0.9em;
        }
        input, select, button {
            padding: 8px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 0.9em;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3);
        }
        button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        button:hover {
            background: linear-gradient(45deg, #45a049, #4CAF50);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .button-group button {
            flex: 1;
        }
        .visualization-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 20px;
            position: relative;
        }
        #canvas {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(180deg, #87CEEB 0%, #98FB98 100%);
        }
        .stats-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 0.8em;
            min-width: 200px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #4CAF50;
        }
        .stat-value {
            color: #fff;
        }
        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        .preset-buttons button {
            font-size: 0.8em;
            padding: 6px 8px;
        }
        .algorithm-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .algorithm-toggle button {
            flex: 1;
            padding: 10px;
            font-size: 0.9em;
        }
        .algorithm-toggle button.active {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }
        .loading.show {
            display: block;
        }
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            .controls-panel {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå≥ Advanced Tree Generator</h1>
            <p>Hybrid L-System + Space Colonization Algorithm</p>
        </div>
        
        <div class="main-content">
            <div class="controls-panel">
                <div class="control-section">
                    <h3>üéØ Algorithm Selection</h3>
                    <div class="algorithm-toggle">
                        <button id="hybridBtn" class="active">Hybrid</button>
                        <button id="traditionalBtn">Traditional</button>
                    </div>
                    <div class="button-group">
                        <button id="generateBtn">Generate Tree</button>
                        <button id="randomBtn">Random</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üå≤ Tree Type</h3>
                    <div class="control-group">
                        <label>Tree Species:</label>
                        <select id="treeType">
                            <option value="broadleaf">Broadleaf (Oak)</option>
                            <option value="pine">Pine (Conifer)</option>
                            <option value="birch">Birch</option>
                            <option value="willow">Willow</option>
                            <option value="palm">Palm</option>
                            <option value="cypress">Cypress</option>
                            <option value="maple">Maple</option>
                        </select>
                    </div>
                    <div class="preset-buttons">
                        <button onclick="setPreset('oak')">Oak</button>
                        <button onclick="setPreset('pine')">Pine</button>
                        <button onclick="setPreset('willow')">Willow</button>
                        <button onclick="setPreset('palm')">Palm</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üìè Basic Parameters</h3>
                    <div class="control-group">
                        <label>Trunk Height:</label>
                        <div class="control-row">
                            <input type="range" id="trunkHeight" min="8" max="20" value="12" step="1">
                            <span id="trunkHeightValue">12</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Branch Length:</label>
                        <div class="control-row">
                            <input type="range" id="branchLength" min="5" max="15" value="8" step="1">
                            <span id="branchLengthValue">8</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Branch Angle (deg):</label>
                        <div class="control-row">
                            <input type="range" id="branchAngle" min="60" max="140" value="100" step="5">
                            <span id="branchAngleValue">100</span>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üß¨ L-System Parameters</h3>
                    <div class="control-group">
                        <label>Iterations:</label>
                        <div class="control-row">
                            <input type="range" id="lSystemIterations" min="2" max="6" value="4" step="1">
                            <span id="lSystemIterationsValue">4</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Angle (deg):</label>
                        <div class="control-row">
                            <input type="range" id="lSystemAngle" min="15" max="45" value="30" step="5">
                            <span id="lSystemAngleValue">30</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Length Factor:</label>
                        <div class="control-row">
                            <input type="range" id="lengthFactor" min="0.5" max="0.9" value="0.7" step="0.1">
                            <span id="lengthFactorValue">0.7</span>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üåø Space Colonization</h3>
                    <div class="control-group">
                        <label>Influence Radius:</label>
                        <div class="control-row">
                            <input type="range" id="influenceRadius" min="1" max="5" value="3" step="0.5">
                            <span id="influenceRadiusValue">3</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Kill Radius:</label>
                        <div class="control-row">
                            <input type="range" id="killRadius" min="0.1" max="1" value="0.5" step="0.1">
                            <span id="killRadiusValue">0.5</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Step Size:</label>
                        <div class="control-row">
                            <input type="range" id="stepSize" min="0.1" max="1" value="0.5" step="0.1">
                            <span id="stepSizeValue">0.5</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Point Density:</label>
                        <div class="control-row">
                            <input type="range" id="pointDensity" min="0.05" max="0.3" value="0.15" step="0.01">
                            <span id="pointDensityValue">0.15</span>
                        </div>
                    </div>
                </div>

                <div class="control-section">
                    <h3>üé® Rendering</h3>
                    <div class="control-group">
                        <label>Ring Segments:</label>
                        <div class="control-row">
                            <input type="range" id="ringSegments" min="4" max="16" value="8" step="1">
                            <span id="ringSegmentsValue">8</span>
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Show Skeleton:</label>
                        <input type="checkbox" id="showSkeleton">
                    </div>
                    <div class="control-group">
                        <label>Wireframe Mode:</label>
                        <input type="checkbox" id="wireframeMode">
                    </div>
                </div>
            </div>

            <div class="visualization-panel">
                <canvas id="canvas"></canvas>
                <div class="stats-panel">
                    <div class="stat-row">
                        <span class="stat-label">Skeleton Segments:</span>
                        <span class="stat-value" id="skeletonCount">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Fine Branches:</span>
                        <span class="stat-value" id="fineCount">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Leaf Clusters:</span>
                        <span class="stat-value" id="leafCount">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Generation Time:</span>
                        <span class="stat-value" id="genTime">0ms</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">FPS:</span>
                        <span class="stat-value" id="fps">60</span>
                    </div>
                </div>
                <div class="loading" id="loading">
                    <div>Generating Tree...</div>
                    <div style="font-size: 0.8em; margin-top: 10px;">Please wait</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from './src/three.module.js';
        import { VoxelTree } from './src/procedural-tree-voxel.js';
        import TreeOptions from './src/tree-options.js';

        // Global variables
        let scene, camera, renderer, controls;
        let currentTree = null;
        let treeGroup = new THREE.Group();
        let useHybrid = true;
        let animationId;
        let lastTime = 0;
        let frameCount = 0;
        let fps = 60;

        // Initialize Three.js scene
        function initScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);

            const canvas = document.getElementById('canvas');
            const aspect = canvas.clientWidth / canvas.clientHeight;
            
            camera = new THREE.PerspectiveCamera(75, aspect, 0.1, 1000);
            camera.position.set(25, 20, 25);
            camera.lookAt(0, 10, 0);

            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.setPixelRatio(window.devicePixelRatio);

            // Add lighting
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 10);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 50;
            directionalLight.shadow.camera.left = -20;
            directionalLight.shadow.camera.right = 20;
            directionalLight.shadow.camera.top = 20;
            directionalLight.shadow.camera.bottom = -20;
            scene.add(directionalLight);

            // Add ground
            const groundGeometry = new THREE.PlaneGeometry(100, 100);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x90EE90 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // Add tree group
            scene.add(treeGroup);

            // Handle window resize
            window.addEventListener('resize', onWindowResize);

            animate();
        }

        function onWindowResize() {
            const canvas = renderer.domElement;
            const width = canvas.clientWidth;
            const height = canvas.clientHeight;
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        }

        function animate() {
            animationId = requestAnimationFrame(animate);
            
            const currentTime = performance.now();
            frameCount++;
            
            if (currentTime - lastTime >= 1000) {
                fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
                frameCount = 0;
                lastTime = currentTime;
                document.getElementById('fps').textContent = fps;
            }
            
            // Rotate camera around tree
            const time = currentTime * 0.001;
            camera.position.x = Math.cos(time * 0.3) * 30;
            camera.position.z = Math.sin(time * 0.3) * 30;
            camera.position.y = 20 + Math.sin(time * 0.2) * 5;
            camera.lookAt(0, 10, 0);
            
            renderer.render(scene, camera);
        }

        // Generate tree with current parameters
        async function generateTree() {
            const loading = document.getElementById('loading');
            loading.classList.add('show');
            
            try {
                const startTime = performance.now();
                
                // Get parameters from UI
                const treeType = document.getElementById('treeType').value;
                const trunkHeight = parseInt(document.getElementById('trunkHeight').value);
                const branchLength = parseInt(document.getElementById('branchLength').value);
                const branchAngle = parseInt(document.getElementById('branchAngle').value);
                const lSystemIterations = parseInt(document.getElementById('lSystemIterations').value);
                const lSystemAngle = parseInt(document.getElementById('lSystemAngle').value);
                const lengthFactor = parseFloat(document.getElementById('lengthFactor').value);
                const influenceRadius = parseFloat(document.getElementById('influenceRadius').value);
                const killRadius = parseFloat(document.getElementById('killRadius').value);
                const stepSize = parseFloat(document.getElementById('stepSize').value);
                const pointDensity = parseFloat(document.getElementById('pointDensity').value);
                const ringSegments = parseInt(document.getElementById('ringSegments').value);
                const showSkeleton = document.getElementById('showSkeleton').checked;
                const wireframeMode = document.getElementById('wireframeMode').checked;

                // Create TreeOptions
                const options = new TreeOptions();
                options.type = treeType;
                
                // Configure branch parameters
                for (let lvl = 0; lvl <= 3; lvl++) {
                    options.branch.length[lvl] = lvl === 0 ? trunkHeight : branchLength * Math.pow(0.7, lvl-1);
                    options.branch.radius[lvl] = lvl === 0 ? 1.5 : 0.7 * Math.pow(0.7, lvl-1);
                    options.branch.sections[lvl] = lvl === 0 ? 12 : 8;
                    options.branch.segments[lvl] = lvl === 0 ? 8 : 6;
                    options.branch.angle[lvl] = branchAngle;
                    options.branch.children[lvl] = lvl === 0 ? 7 : 3;
                    options.branch.start[lvl] = 0.4;
                    options.branch.taper[lvl] = 0.7;
                    options.branch.twist[lvl] = 0;
                    options.branch.gnarliness[lvl] = 0.15 + 0.05 * lvl;
                }

                // Update hybrid system parameters
                if (currentTree && currentTree.lSystemSkeleton) {
                    currentTree.lSystemSkeleton.iterations = lSystemIterations;
                    currentTree.lSystemSkeleton.angle = (lSystemAngle * Math.PI) / 180;
                    currentTree.lSystemSkeleton.lengthFactor = lengthFactor;
                }
                
                if (currentTree && currentTree.spaceColonization) {
                    currentTree.spaceColonization.influenceRadius = influenceRadius;
                    currentTree.spaceColonization.killRadius = killRadius;
                    currentTree.spaceColonization.stepSize = stepSize;
                    currentTree.spaceColonization.pointDensity = pointDensity;
                }

                // Generate tree
                currentTree = new VoxelTree(options);
                currentTree.useHybrid = useHybrid;
                
                // Generate mesh
                const treeMesh = currentTree.toMesh({ 
                    ringSides: ringSegments, 
                    useHybrid: useHybrid,
                    debugSkeleton: showSkeleton 
                });

                // Apply wireframe mode if enabled
                if (wireframeMode) {
                    treeMesh.traverse((child) => {
                        if (child.isMesh) {
                            child.material.wireframe = true;
                        }
                    });
                }

                // Clear existing tree and add new one
                treeGroup.clear();
                treeMesh.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                    }
                });
                treeGroup.add(treeMesh);

                // Update statistics
                const endTime = performance.now();
                const generationTime = Math.round(endTime - startTime);
                
                updateTreeStats(generationTime);
                
            } catch (error) {
                console.error('Error generating tree:', error);
                alert('Error generating tree: ' + error.message);
            } finally {
                loading.classList.remove('show');
            }
        }

        // Update tree statistics display
        function updateTreeStats(generationTime) {
            if (!currentTree) return;

            const segments = currentTree.hybridSegments || [];
            const skeletonSegments = segments.filter(s => s.type === 'skeleton');
            const fineSegments = segments.filter(s => s.type === 'fine');

            document.getElementById('skeletonCount').textContent = skeletonSegments.length;
            document.getElementById('fineCount').textContent = fineSegments.length;
            document.getElementById('leafCount').textContent = currentTree.leafClusters.length;
            document.getElementById('genTime').textContent = generationTime + 'ms';
        }

        // Set tree presets
        window.setPreset = function(preset) {
            const presets = {
                oak: { type: 'broadleaf', trunkHeight: 12, branchLength: 8, branchAngle: 100 },
                pine: { type: 'pine', trunkHeight: 15, branchLength: 6, branchAngle: 95 },
                willow: { type: 'willow', trunkHeight: 10, branchLength: 12, branchAngle: 110 },
                palm: { type: 'palm', trunkHeight: 18, branchLength: 10, branchAngle: 110 }
            };

            const presetData = presets[preset];
            if (presetData) {
                document.getElementById('treeType').value = presetData.type;
                document.getElementById('trunkHeight').value = presetData.trunkHeight;
                document.getElementById('trunkHeightValue').textContent = presetData.trunkHeight;
                document.getElementById('branchLength').value = presetData.branchLength;
                document.getElementById('branchLengthValue').textContent = presetData.branchLength;
                document.getElementById('branchAngle').value = presetData.branchAngle;
                document.getElementById('branchAngleValue').textContent = presetData.branchAngle;
                
                generateTree();
            }
        };

        // Toggle between hybrid and traditional algorithms
        function toggleAlgorithm(useHybridAlgorithm) {
            useHybrid = useHybridAlgorithm;
            
            document.getElementById('hybridBtn').classList.toggle('active', useHybrid);
            document.getElementById('traditionalBtn').classList.toggle('active', !useHybrid);
            
            generateTree();
        }

        // Random tree generation
        function generateRandomTree() {
            document.getElementById('trunkHeight').value = Math.floor(Math.random() * 12) + 8;
            document.getElementById('branchLength').value = Math.floor(Math.random() * 10) + 5;
            document.getElementById('branchAngle').value = Math.floor(Math.random() * 60) + 80;
            document.getElementById('lSystemIterations').value = Math.floor(Math.random() * 4) + 2;
            document.getElementById('lSystemAngle').value = Math.floor(Math.random() * 30) + 15;
            document.getElementById('lengthFactor').value = (Math.random() * 0.4 + 0.5).toFixed(1);
            document.getElementById('influenceRadius').value = (Math.random() * 4 + 1).toFixed(1);
            document.getElementById('killRadius').value = (Math.random() * 0.9 + 0.1).toFixed(1);
            document.getElementById('stepSize').value = (Math.random() * 0.9 + 0.1).toFixed(1);
            document.getElementById('pointDensity').value = (Math.random() * 0.25 + 0.05).toFixed(2);
            
            // Update all value displays
            updateAllValueDisplays();
            
            generateTree();
        }

        // Update all range input value displays
        function updateAllValueDisplays() {
            const ranges = document.querySelectorAll('input[type="range"]');
            ranges.forEach(range => {
                const valueSpan = document.getElementById(range.id + 'Value');
                if (valueSpan) {
                    valueSpan.textContent = range.value;
                }
            });
        }

        // Event listeners
        document.getElementById('generateBtn').addEventListener('click', generateTree);
        document.getElementById('randomBtn').addEventListener('click', generateRandomTree);
        document.getElementById('hybridBtn').addEventListener('click', () => toggleAlgorithm(true));
        document.getElementById('traditionalBtn').addEventListener('click', () => toggleAlgorithm(false));

        // Range input event listeners
        const ranges = document.querySelectorAll('input[type="range"]');
        ranges.forEach(range => {
            range.addEventListener('input', function() {
                const valueSpan = document.getElementById(this.id + 'Value');
                if (valueSpan) {
                    valueSpan.textContent = this.value;
                }
            });
        });

        // Checkbox event listeners
        document.getElementById('showSkeleton').addEventListener('change', generateTree);
        document.getElementById('wireframeMode').addEventListener('change', generateTree);

        // Initialize scene and generate first tree
        initScene();
        generateTree();
    </script>
</body>
</html> 