<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformer Trading System Test - Rekursing</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .test-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .test-section h2 {
            margin-top: 0;
            color: #ffd700;
            font-size: 1.5rem;
        }

        .button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 5px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .status.success {
            background: rgba(46, 204, 113, 0.3);
            border: 1px solid #2ecc71;
        }

        .status.error {
            background: rgba(231, 76, 60, 0.3);
            border: 1px solid #e74c3c;
        }

        .status.info {
            background: rgba(52, 152, 219, 0.3);
            border: 1px solid #3498db;
        }

        .status.warning {
            background: rgba(243, 156, 18, 0.3);
            border: 1px solid #f39c12;
        }

        .results {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            height: 400px;
            position: relative;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            transition: width 0.3s ease;
        }

        .signal-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #ffd700;
        }

        .signal-buy {
            border-left-color: #2ecc71;
        }

        .signal-sell {
            border-left-color: #e74c3c;
        }

        .signal-hold {
            border-left-color: #95a5a6;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Transformer Trading System Test</h1>
        
        <div class="test-section">
            <h2>üöÄ System Initialization</h2>
            <button id="initBtn" class="button">Initialize Transformer Trading System</button>
            <div id="initStatus" class="status info">Click to initialize the transformer trading system</div>
        </div>

        <div class="test-section">
            <h2>üìä Data Preparation</h2>
            <button id="prepareDataBtn" class="button" disabled>Prepare Training Data</button>
            <button id="generateDataBtn" class="button">Generate Sample Data</button>
            <button id="loadRealDataBtn" class="button">Load Real EURUSD Data</button>
            <div id="dataStatus" class="status info">Load real EURUSD data or generate sample data to test the system</div>
            <div id="dataProgress" class="progress-bar" style="display: none;">
                <div class="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üéØ Model Training</h2>
            <button id="trainBtn" class="button" disabled>Train Transformer Model</button>
            <div id="trainStatus" class="status info">Train the transformer model with prepared data</div>
            <div id="trainProgress" class="progress-bar" style="display: none;">
                <div class="progress-fill" style="width: 0%"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üìà Signal Generation</h2>
            <button id="generateSignalsBtn" class="button" disabled>Generate Trading Signals</button>
            <div id="signalsStatus" class="status info">Generate combined trading signals</div>
        </div>

        <div class="test-section">
            <h2>üìä System Metrics</h2>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div id="modelAccuracy" class="metric-value">-</div>
                    <div class="metric-label">Model Accuracy</div>
                </div>
                <div class="metric-card">
                    <div id="trainingEpochs" class="metric-value">-</div>
                    <div class="metric-label">Training Epochs</div>
                </div>
                <div class="metric-card">
                    <div id="signalCount" class="metric-value">-</div>
                    <div class="metric-label">Signals Generated</div>
                </div>
                <div class="metric-card">
                    <div id="buySignals" class="metric-value">-</div>
                    <div class="metric-label">Buy Signals</div>
                </div>
                <div class="metric-card">
                    <div id="sellSignals" class="metric-value">-</div>
                    <div class="metric-label">Sell Signals</div>
                </div>
                <div class="metric-card">
                    <div id="avgConfidence" class="metric-value">-</div>
                    <div class="metric-label">Avg Confidence</div>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>üìã Recent Signals</h2>
            <div id="signalsList"></div>
        </div>

        <div class="test-section">
            <h2>üìù System Log</h2>
            <div id="logOutput" class="results"></div>
        </div>
    </div>

    <script type="module">
        import TransformerTrading from './src/game/mechanics/TransformerTrading.js';

        class TransformerTradingTest {
            constructor() {
                this.transformerTrading = null;
                this.sampleData = [];
                this.signals = [];
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                document.getElementById('initBtn').addEventListener('click', () => this.initializeSystem());
                document.getElementById('generateDataBtn').addEventListener('click', () => this.generateSampleData());
                document.getElementById('loadRealDataBtn').addEventListener('click', () => this.loadRealData());
                document.getElementById('prepareDataBtn').addEventListener('click', () => this.prepareTrainingData());
                document.getElementById('trainBtn').addEventListener('click', () => this.trainModel());
                document.getElementById('generateSignalsBtn').addEventListener('click', () => this.generateSignals());
            }

            log(message, type = 'info') {
                const logOutput = document.getElementById('logOutput');
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.innerHTML = `[${timestamp}] ${message}`;
                logOutput.appendChild(logEntry);
                logOutput.scrollTop = logOutput.scrollHeight;
                console.log(message);
            }

            updateStatus(elementId, message, type = 'info') {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.className = `status ${type}`;
            }

            updateProgress(elementId, percentage) {
                const progressFill = document.querySelector(`#${elementId} .progress-fill`);
                progressFill.style.width = `${percentage}%`;
            }

            async initializeSystem() {
                try {
                    this.updateStatus('initStatus', 'üîÑ Initializing transformer trading system...', 'info');
                    document.getElementById('initBtn').disabled = true;
                    document.getElementById('initBtn').innerHTML = '<span class="loading"></span> Initializing...';

                    this.transformerTrading = new TransformerTrading();
                    await this.transformerTrading.initialize();

                    this.updateStatus('initStatus', '‚úÖ Transformer trading system initialized successfully!', 'success');
                    document.getElementById('prepareDataBtn').disabled = false;
                    
                    this.log('Transformer trading system initialized successfully');
                    this.updateMetrics();

                } catch (error) {
                    this.updateStatus('initStatus', `‚ùå Initialization failed: ${error.message}`, 'error');
                    this.log(`Initialization error: ${error.message}`, 'error');
                } finally {
                    document.getElementById('initBtn').disabled = false;
                    document.getElementById('initBtn').textContent = 'Initialize Transformer Trading System';
                }
            }

            generateSampleData() {
                this.log('Generating sample price data...');
                this.updateStatus('dataStatus', 'üîÑ Generating sample data...', 'info');
                
                // Generate 1000 sample price points
                const basePrice = 100;
                let currentPrice = basePrice;
                this.sampleData = [];

                for (let i = 0; i < 1000; i++) {
                    // Simulate realistic price movements
                    const volatility = 0.02; // 2% daily volatility
                    const trend = 0.0001; // Slight upward trend
                    const random = (Math.random() - 0.5) * 2;
                    
                    currentPrice *= (1 + trend + random * volatility);
                    
                    const timestamp = Date.now() - (1000 - i) * 3600000; // Hourly data
                    
                    this.sampleData.push({
                        timestamp: timestamp,
                        open: currentPrice * (1 + (Math.random() - 0.5) * 0.01),
                        high: currentPrice * (1 + Math.random() * 0.02),
                        low: currentPrice * (1 - Math.random() * 0.02),
                        close: currentPrice,
                        volume: Math.floor(Math.random() * 1000000) + 100000
                    });
                }

                this.updateStatus('dataStatus', `‚úÖ Generated ${this.sampleData.length} sample price points`, 'success');
                this.log(`Generated ${this.sampleData.length} sample price points`);
                
                document.getElementById('prepareDataBtn').disabled = false;
            }

            async loadRealData() {
                if (!this.transformerTrading) {
                    this.updateStatus('dataStatus', '‚ùå System not initialized', 'error');
                    return;
                }

                try {
                    this.updateStatus('dataStatus', 'üîÑ Loading real EURUSD data...', 'info');
                    document.getElementById('loadRealDataBtn').disabled = true;
                    document.getElementById('loadRealDataBtn').innerHTML = '<span class="loading"></span> Loading...';
                    document.getElementById('dataProgress').style.display = 'block';

                    // Simulate loading progress
                    for (let i = 0; i <= 100; i += 10) {
                        this.updateProgress('dataProgress', i);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    // Load real data
                    this.sampleData = await this.transformerTrading.loadRealData();
                    
                    // Display data statistics
                    const stats = this.transformerTrading.getDataStats();
                    if (stats) {
                        this.log(`Data Statistics: ${stats.totalPoints} points, ${stats.dataQuality} quality`);
                        this.log(`Date Range: ${stats.dateRange.start.toLocaleDateString()} to ${stats.dateRange.end.toLocaleDateString()}`);
                        this.log(`Price Range: $${stats.priceStats.min.toFixed(4)} to $${stats.priceStats.max.toFixed(4)}`);
                        this.log(`Volatility: ${(stats.volatility * 100).toFixed(2)}%`);
                    }

                    this.updateStatus('dataStatus', `‚úÖ Loaded ${this.sampleData.length} real EURUSD data points!`, 'success');
                    document.getElementById('prepareDataBtn').disabled = false;
                    this.log(`Loaded ${this.sampleData.length} real EURUSD data points`);

                } catch (error) {
                    this.updateStatus('dataStatus', `‚ùå Failed to load real data: ${error.message}`, 'error');
                    this.log(`Data loading error: ${error.message}`, 'error');
                } finally {
                    document.getElementById('loadRealDataBtn').disabled = false;
                    document.getElementById('loadRealDataBtn').textContent = 'Load Real EURUSD Data';
                    document.getElementById('dataProgress').style.display = 'none';
                }
            }

            async prepareTrainingData() {
                if (!this.transformerTrading || !this.sampleData.length) {
                    this.updateStatus('dataStatus', '‚ùå System not initialized or no data available', 'error');
                    return;
                }

                try {
                    this.updateStatus('dataStatus', 'üîÑ Preparing training data...', 'info');
                    document.getElementById('prepareDataBtn').disabled = true;
                    document.getElementById('dataProgress').style.display = 'block';

                    // Simulate data preparation progress
                    for (let i = 0; i <= 100; i += 10) {
                        this.updateProgress('dataProgress', i);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }

                    // Prepare training data
                    this.transformerTrading.prepareTrainingData(this.sampleData);

                    this.updateStatus('dataStatus', '‚úÖ Training data prepared successfully!', 'success');
                    document.getElementById('trainBtn').disabled = false;
                    this.log('Training data prepared successfully');

                } catch (error) {
                    this.updateStatus('dataStatus', `‚ùå Data preparation failed: ${error.message}`, 'error');
                    this.log(`Data preparation error: ${error.message}`, 'error');
                } finally {
                    document.getElementById('prepareDataBtn').disabled = false;
                    document.getElementById('dataProgress').style.display = 'none';
                }
            }

            async trainModel() {
                if (!this.transformerTrading) {
                    this.updateStatus('trainStatus', '‚ùå System not initialized', 'error');
                    return;
                }

                try {
                    this.updateStatus('trainStatus', 'üîÑ Training transformer model...', 'info');
                    document.getElementById('trainBtn').disabled = true;
                    document.getElementById('trainBtn').innerHTML = '<span class="loading"></span> Training...';
                    document.getElementById('trainProgress').style.display = 'block';

                    // Simulate training progress
                    const trainingInterval = setInterval(() => {
                        const currentProgress = parseInt(document.querySelector('#trainProgress .progress-fill').style.width) || 0;
                        if (currentProgress < 90) {
                            this.updateProgress('trainProgress', currentProgress + Math.random() * 10);
                        }
                    }, 500);

                    // Train the model
                    await this.transformerTrading.trainModel(20, 16); // 20 epochs, batch size 16

                    clearInterval(trainingInterval);
                    this.updateProgress('trainProgress', 100);

                    this.updateStatus('trainStatus', '‚úÖ Model training completed successfully!', 'success');
                    document.getElementById('generateSignalsBtn').disabled = false;
                    this.log('Model training completed successfully');
                    this.updateMetrics();

                } catch (error) {
                    this.updateStatus('trainStatus', `‚ùå Training failed: ${error.message}`, 'error');
                    this.log(`Training error: ${error.message}`, 'error');
                } finally {
                    document.getElementById('trainBtn').disabled = false;
                    document.getElementById('trainBtn').textContent = 'Train Transformer Model';
                    document.getElementById('trainProgress').style.display = 'none';
                }
            }

            async generateSignals() {
                if (!this.transformerTrading) {
                    this.updateStatus('signalsStatus', '‚ùå System not initialized', 'error');
                    return;
                }

                try {
                    this.updateStatus('signalsStatus', 'üîÑ Generating trading signals...', 'info');
                    document.getElementById('generateSignalsBtn').disabled = true;
                    document.getElementById('generateSignalsBtn').innerHTML = '<span class="loading"></span> Generating...';

                    // Generate signals
                    this.signals = this.transformerTrading.generateSignals(this.sampleData);

                    this.updateStatus('signalsStatus', `‚úÖ Generated ${this.signals.length} trading signals!`, 'success');
                    this.log(`Generated ${this.signals.length} trading signals`);
                    
                    this.displaySignals();
                    this.updateMetrics();

                } catch (error) {
                    this.updateStatus('signalsStatus', `‚ùå Signal generation failed: ${error.message}`, 'error');
                    this.log(`Signal generation error: ${error.message}`, 'error');
                } finally {
                    document.getElementById('generateSignalsBtn').disabled = false;
                    document.getElementById('generateSignalsBtn').textContent = 'Generate Trading Signals';
                }
            }

            displaySignals() {
                const signalsList = document.getElementById('signalsList');
                signalsList.innerHTML = '';

                // Display last 10 signals
                const recentSignals = this.signals.slice(-10).reverse();

                recentSignals.forEach(signal => {
                    const signalElement = document.createElement('div');
                    signalElement.className = `signal-item signal-${signal.signal.toLowerCase()}`;
                    
                    const timestamp = new Date(signal.timestamp).toLocaleString();
                    const sources = signal.sources ? signal.sources.join(', ') : 'transformer';
                    
                    signalElement.innerHTML = `
                        <strong>${signal.signal}</strong> at $${signal.price.toFixed(2)}
                        <br>
                        <small>Time: ${timestamp} | Confidence: ${(signal.confidence * 100).toFixed(1)}% | Sources: ${sources}</small>
                        ${signal.predictedPrice ? `<br><small>Predicted: $${signal.predictedPrice.toFixed(2)} (${(signal.priceChange * 100).toFixed(1)}%)</small>` : ''}
                    `;
                    
                    signalsList.appendChild(signalElement);
                });
            }

            updateMetrics() {
                if (!this.transformerTrading) return;

                const stats = this.transformerTrading.getModelStats();
                const tradingStats = this.transformerTrading.getTradingStats();

                if (stats) {
                    document.getElementById('modelAccuracy').textContent = 
                        stats.trainingState?.bestLoss ? (1 - stats.trainingState.bestLoss).toFixed(3) : '-';
                    document.getElementById('trainingEpochs').textContent = 
                        stats.trainingState?.epoch || '-';
                }

                if (this.signals.length > 0) {
                    document.getElementById('signalCount').textContent = this.signals.length;
                    
                    const buySignals = this.signals.filter(s => s.signal === 'BUY').length;
                    const sellSignals = this.signals.filter(s => s.signal === 'SELL').length;
                    
                    document.getElementById('buySignals').textContent = buySignals;
                    document.getElementById('sellSignals').textContent = sellSignals;
                    
                    const avgConfidence = this.signals.reduce((sum, s) => sum + s.confidence, 0) / this.signals.length;
                    document.getElementById('avgConfidence').textContent = (avgConfidence * 100).toFixed(1) + '%';
                }
            }
        }

        // Initialize the test
        const test = new TransformerTradingTest();
        test.log('Transformer Trading System Test initialized');
    </script>
</body>
</html> 